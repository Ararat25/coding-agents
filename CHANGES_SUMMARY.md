# Исправления проблем в Coding Agents

## Проблема 1: Ошибка 422 при попытке approve своего PR

### Описание проблемы
Агент пытался сделать APPROVE своего собственного Pull Request, что запрещено GitHub API. Это приводило к ошибке:
```
Review Can not approve your own pull request
```

### Решение
1. **Изменен файл `src/coding_agents/services/reviewer_agent.py`:**
   - Убрана возможность агента делать `APPROVE` и `REQUEST_CHANGES`
   - Теперь агент использует **только** `COMMENT` для всех типов review
   - Это необходимо, так как GitHub API запрещает автору PR (агенту) одобрять или запрашивать изменения в своем собственном PR
   - Для случая когда код готов к approve, агент оставляет `COMMENT` с явным указанием "✅ Код готов к approve"
   - Добавлено сообщение что ожидается окончательный approve от человека

2. **Логика работы:**
   - `CHANGES_REQUESTED` → агент публикует review как `COMMENT` с детальным описанием необходимых правок
   - `APPROVED` → агент публикует review как `COMMENT` и явным указанием что код готов
   - `COMMENT` → агент публикует обычный комментарий
   - Окончательный approve делает только человек

## Проблема 2: Code Agent не учитывает контекст проекта

### Описание проблемы
Code Agent генерировал общие решения вместо конкретных, так как не имел доступа к:
- Структуре проекта
- Документации (README, ARCHITECTURE и т.д.)
- Существующему коду
- Зависимостям и конфигурации

### Решение

1. **Добавлены новые методы в `src/coding_agents/infrastructure/github_client.py`:**
   - `get_repository_tree()` - получение дерева файлов репозитория
   - `get_file_content()` - получение содержимого конкретного файла
   - `get_repository_files()` - получение списка файлов из директории

2. **Обновлен `src/coding_agents/services/code_agent.py`:**
   - Метод `_get_repository_structure()` теперь реально получает контекст проекта:
     * Дерево файлов (до 3 уровней вложенности)
     * Содержимое важных файлов (README.md, requirements.txt, pyproject.toml и т.д.)
     * Содержимое ключевых Python файлов (main.py, app.py, __init__.py и т.д.)
   - Добавлен метод `_find_key_python_files()` для поиска важных файлов кода

3. **Обновлены промпты в `src/coding_agents/prompts/code_agent_prompts.py`:**
   - Добавлены принципы работы с контекстом проекта
   - Явное указание изучать структуру, документацию и существующий код
   - Акцент на конкретные решения, а не общие формулировки
   - Инструкции по использованию контекста для интеграции с существующим кодом

4. **Обновлен интерфейс `src/coding_agents/domain/interfaces.py`:**
   - Добавлены абстрактные методы для новой функциональности
   - Обеспечена типобезопасность и соответствие архитектуре

## Результат

После внесения изменений:

1. ✅ Агент больше не пытается делать APPROVE своих PR
2. ✅ Агент явно указывает когда код готов к approve человеком
3. ✅ Code Agent получает полный контекст проекта перед генерацией кода
4. ✅ Генерируемый код учитывает существующую архитектуру и стиль проекта
5. ✅ Решения становятся конкретными, а не общими формулировками

## Измененные файлы

1. `src/coding_agents/services/reviewer_agent.py` - логика публикации review
2. `src/coding_agents/services/code_agent.py` - получение контекста проекта
3. `src/coding_agents/infrastructure/github_client.py` - методы работы с файлами
4. `src/coding_agents/prompts/code_agent_prompts.py` - улучшенные промпты
5. `src/coding_agents/domain/interfaces.py` - обновленные интерфейсы

## Рекомендации по использованию

1. После деплоя новой версии, проверьте что GitHub токен имеет права на чтение содержимого репозитория
2. Для больших репозиториев контекст может быть обрезан - это нормально и предусмотрено
3. Человек должен делать финальный approve PR после проверки агентом
4. Агент теперь работает как помощник-ревьюер, а не как автоматический approver
