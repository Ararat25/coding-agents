"""Промпты для Code Agent."""

from typing import Optional


def get_code_agent_system_prompt() -> str:
    """Системный промпт для Code Agent."""
    return """Ты - элитный Senior Python разработчик (Staff Engineer).
Твоя задача - реализовывать задачи из GitHub Issue с безупречным качеством.

КРИТИЧЕСКИЕ ПРАВИЛА:
1. ЗАПРЕЩЕНО писать пустые комментарии или заглушки (типа "тесты функций", "реализация здесь").
2. ТЫ ДОЛЖЕН писать РЕАЛЬНЫЙ, РАБОЧИЙ код, который решает задачу.
3. ИСПОЛЬЗУЙ ПРЕДОСТАВЛЕННЫЙ КОНТЕКСТ: изучи существующие импорты, классы и методы. Твой код должен интегрироваться в проект бесшовно.
4. ЕСЛИ НУЖНО НАПИСАТЬ ТЕСТЫ: пиши реальные тест-кейсы с использованием unittest или pytest (посмотри что используется в проекте).
5. СОБЛЮДАЙ СТИЛЬ: если проект использует аннотации типов, асинхронность или специфические библиотеки - используй их.
6. ПЛАН ДОЛЖЕН БЫТЬ ДЕТАЛЬНЫМ: опиши, что именно ты меняешь и почему.
7. ОШИБКИ И ИСКЛЮЧЕНИЯ: всегда обрабатывай потенциальные ошибки.

Если ты не видишь достаточно кода в контексте для решения задачи - попробуй воссоздать логику на основе структуры проекта, но никогда не сдавай пустую работу."""


def get_code_agent_user_prompt(
    issue_title: str,
    issue_body: str,
    repository_structure: Optional[str] = None,
    previous_feedback: Optional[str] = None,
    iteration_number: int = 1,
) -> str:
    """Пользовательский промпт для Code Agent."""
    prompt = f"""Задача из GitHub Issue:

**Заголовок:** {issue_title}

**Описание:**
{issue_body}
"""

    if previous_feedback:
        prompt += f"""

**Замечания от Reviewer (итерация {iteration_number - 1}):**
{previous_feedback}

Учти эти замечания при исправлении кода.
"""

    if repository_structure:
        prompt += f"""

**КОНТЕКСТ ПРОЕКТА (ОБЯЗАТЕЛЬНО ИЗУЧИ!):**
{repository_structure}

ВАЖНО: Используй этот контекст для:
- Понимания архитектуры проекта
- Соблюдения стиля кода и паттернов
- Интеграции с существующими классами и функциями
- Использования правильных импортов и зависимостей
"""
    else:
        prompt += """

ПРЕДУПРЕЖДЕНИЕ: Контекст проекта недоступен. Реализуй решение на основе общепринятых практик Python.
"""

    prompt += """

**Твоя задача:**
1. Проанализируй требования
2. Определи какие файлы нужно создать/изменить/удалить
3. Реализуй изменения в коде

**Формат ответа (JSON):**
{
  "plan": "Краткое описание плана реализации",
  "changes": [
    {
      "file_path": "путь/к/файлу.py",
      "operation": "create|modify|delete",
      "content": "полное содержимое файла (для create/modify)",
      "old_content": "старое содержимое (только для modify, если нужно точечное изменение)",
      "line_start": номер_строки_начала (опционально, для точечного изменения),
      "line_end": номер_строки_конца (опционально, для точечного изменения)
    }
  ],
  "commit_message": "Краткое описание изменений для коммита"
}

**Важно:**
- Для operation="modify" можно указать либо полный content (замена всего файла), либо old_content + line_start/line_end (точечное изменение)
- Все пути файлов должны быть относительными от корня репозитория
- Код должен быть рабочим и следовать стилю проекта
- Если нужно добавить зависимости - укажи это в plan, но не меняй файлы зависимостей без необходимости
"""

    return prompt


def get_code_agent_response_format() -> dict:
    """Формат ответа Code Agent."""
    return {
        "type": "object",
        "properties": {
            "plan": {
                "type": "string",
                "description": "Краткое описание плана реализации",
            },
            "changes": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "file_path": {"type": "string"},
                        "operation": {"type": "string", "enum": ["create", "modify", "delete"]},
                        "content": {"type": "string"},
                        "old_content": {"type": "string"},
                        "line_start": {"type": "integer"},
                        "line_end": {"type": "integer"},
                    },
                    "required": ["file_path", "operation"],
                },
            },
            "commit_message": {"type": "string"},
        },
        "required": ["plan", "changes", "commit_message"],
    }
